<template>
  <div :class="['bahur-terminal', { 'noir': isDark }]" :style="{ '--p-cols': activePriceCount }">
    <div class="container">
      
      <header class="header-manifest">
        <div class="logo-strip-box">
          <div class="strip top"></div>
          <h1 class="logo-text">BAHUR</h1>
          <div class="strip bottom"></div>
          <div class="logo-url">WWW.BAHUR.STORE</div>
          <button @click="isDark = !isDark" class="theme-centered">{{ isDark ? '☀' : '☾' }}</button>
        </div>
      </header>

      <section class="dashboard">
        <div class="dash-grid">
          <div class="stat-card">
            <label class="d-label">АРОМАТОВ</label>
            <div class="v mono">{{ stats.total }}</div>
          </div>
          
          <div class="stat-card">
            <label class="d-label">СРЕДНЯЯ ЦЕНА</label>
            <div class="avg-list mono responsive-text">
              <div v-if="showPrices.p50" class="avg-row">50г: <span class="val">{{ stats.avg50 }}₽</span></div>
              <div v-if="showPrices.p500" class="avg-row">500г: <span class="val">{{ stats.avg500 }}₽</span></div>
              <div v-if="showPrices.p1000" class="avg-row">1кг: <span class="val">{{ stats.avg1000 }}₽</span></div>
            </div>
          </div>

          <div class="stat-card">
            <label class="d-label">НА СКЛАДЕ</label>
            <div class="stock-box-stacked">
              <div class="v-small mono">{{ stats.availability }}%</div>
              <div class="q-track-neon"><div class="q-fill-neon" :style="{ width: stats.availability + '%' }"></div></div>
            </div>
          </div>

          <div class="stat-card">
            <label class="d-label">КАЧЕСТВО %</label>
            <div class="q-list">
              <div v-for="q in ['TOP', 'Q1', 'Q2']" :key="q" class="q-row-stacked">
                <div class="q-meta">
                   <span class="mono">{{ q }}</span>
                   <span class="mono op-5">{{ stats.qualityPerc[q] }}%</span>
                </div>
                <div class="q-track-neon"><div class="q-fill-neon" :style="{ width: stats.qualityPerc[q] + '%' }"></div></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="table-frame">
        <div class="sticky-nav-group">
          
          <section class="controls-luxury relative-zone">
            <div class="top-bar-controls">
              
              <div class="switch-group" @click="toggleNew">
                 <svg class="ctrl-icon-small" viewBox="0 0 24 24"><path fill="currentColor" d="M7,2V13H10V22L17,10H14L17,2H7Z" /></svg>
                 <label class="ctrl-label-inline">НОВИНКИ</label>
                 
                 <div :class="['soft-switch', { 'active': isNewOnly }]">
                   <div class="soft-track"></div>
                   <div class="soft-knob">
                     <div class="knob-dot"></div>
                   </div>
                 </div>
              </div>

              <button @click="showFilters = !showFilters" :class="['settings-btn', { 'active': showFilters }]">
                <template v-if="!showFilters">
                  <svg class="btn-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.35 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.35 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.04 4.95,18.95L7.44,17.95C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.95L19.05,18.95C19.27,19.04 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" /></svg>
                  <span>НАСТРОЙКИ</span>
                </template>
                <template v-else>
                  <svg class="btn-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg>
                  <span>ЗАКРЫТЬ</span>
                </template>
              </button>
            </div>

            <div v-if="showFilters" class="click-overlay" @click="showFilters = false"></div>

            <transition name="pop">
              <div v-if="showFilters" class="bahur-popup-menu">
                <div class="popup-row">
                  <div class="popup-head">
                    <svg class="pop-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,6C8.69,6 6,8.69 6,12C6,15.31 8.69,18 12,18V6Z" /></svg>
                    <span class="popup-label">ПОЛ</span>
                  </div>
                  <div class="seg-control">
                    <button v-for="g in genderOptions" :key="g.val" @click="activeGender = g.val" :class="['seg-btn', { active: activeGender === g.val }]">{{ g.label }}</button>
                  </div>
                </div>
                <div class="popup-row">
                  <div class="popup-head">
                    <svg class="pop-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M21,16.5C21,16.88 20.79,17.21 20.47,17.38L12.57,21.82C12.41,21.94 12.21,22 12,22C11.79,22 11.59,21.94 11.43,21.82L3.53,17.38C3.21,17.21 3,16.88 3,16.5V7.5C3,7.12 3.21,6.79 3.53,6.62L11.43,2.18C11.59,2.06 11.79,2 12,2C12.21,2 12.41,2.06 12.57,2.18L20.47,6.62C20.79,6.79 21,7.12 21,7.5V16.5M12,4.15L6.04,7.5L12,10.85L17.96,7.5L12,4.15M5,15.91L11,19.29V12.58L5,9.21V15.91M19,15.91V9.21L13,12.58V19.29L19,15.91Z" /></svg>
                    <span class="popup-label">ФАБРИКА</span>
                  </div>
                  <div class="seg-control">
                    <button v-for="f in factoryOptions" :key="f.val" @click="activeFactory = f.val" :class="['seg-btn', { active: activeFactory === f.val }]">{{ f.label }}</button>
                  </div>
                </div>
                <div class="popup-row">
                  <div class="popup-head">
                     <svg class="pop-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2L14.5,9H22L16,13.5L18.5,20.5L12,16L5.5,20.5L8,13.5L2,9H9.5L12,2Z" /></svg>
                     <span class="popup-label">КАЧЕСТВО</span>
                  </div>
                  <div class="seg-control">
                    <button v-for="q in qualityOptions" :key="q.val" @click="activeQuality = q.val" :class="['seg-btn', { active: activeQuality === q.val }]">{{ q.label }}</button>
                  </div>
                </div>
                <div class="popup-row">
                  <div class="popup-head">
                    <svg class="pop-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3,18H9V16H3V18M3,6V8H21V6H3M3,13H15V11H3V13Z" /></svg>
                    <span class="popup-label">СОРТИРОВКА</span>
                  </div>
                  <div class="seg-control">
                    <button v-for="s in sortOptions" :key="s.val" 
                            @click="sortBy = s.val" 
                            :class="['seg-btn', { active: sortBy === s.val }]">
                      <span class="sort-content" v-html="s.labelHTML"></span>
                    </button>
                  </div>
                </div>
                <div class="popup-row">
                  <div class="popup-head">
                    <svg class="pop-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M4,2H20A2,2 0 0,1 22,4V20A2,2 0 0,1 20,22H4A2,2 0 0,1 2,20V4A2,2 0 0,1 4,2M4,4V20H8V4H4M10,4V20H14V4H10M16,4V20H20V4H16Z" /></svg>
                    <span class="popup-label">СТОЛБЦЫ</span>
                  </div>
                  <div class="seg-control">
                    <button v-for="(val, key) in priceLabels" :key="key" @click="togglePrice(key)" :class="['seg-btn', { active: showPrices[key] }]">{{ val }}</button>
                  </div>
                </div>
              </div>
            </transition>
          </section>

          <div class="grid-row head no-click">
            <div class="cell id head-txt center">№</div>
            <div class="cell name name-header">
              <div class="search-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg>
                <input v-model="search" type="text" placeholder="ПОИСК" class="header-search" @focus="showSug = true" @blur="hideSug" />
              </div>
            </div>
            <div class="cell desk-only head-txt center">ПОЛ</div>
            <div class="cell desk-only head-txt center">ФАБРИКА</div>
            <div class="cell desk-only head-txt center">КАЧЕСТВО</div>
            
            <div class="price-section head-p" :style="gridStyle">
              <div v-if="showPrices.p50" class="p-col line center">50Г</div>
              <div v-if="showPrices.p500" class="p-col line center">500Г</div>
              <div v-if="showPrices.p1000" class="p-col last center">1КГ</div>
            </div>
          </div>
        </div>

        <div v-if="loading" class="loading-container"><div class="loading-line"></div></div>
        
        <div v-else class="grid-table">
          <div v-for="p in sortedProducts" :key="p.id" 
               :class="['grid-row', 'clickable-row', { 'out': p.isOut, 'simulated-hover': autoHighlightId === p.id }]"
               @click="p.link && p.link.length > 5 ? open(p.link) : null">
            
            <div class="row-visual-layer">
              <div class="cell id-zone-square center">
                <div class="id-sq-top mono">{{ p.id }}</div>
                <div v-if="p.isNew" class="badge-new-square">NEW</div>
                <div :class="['lamp-sq', p.isOut ? 'red' : (p.isNew ? 'green' : 'standard')]"></div>
              </div>
              
              <div class="cell name border-right-mobile">
                <div class="scent-info">
                  <span class="brand-code">{{ p.brand }}</span>
                  <span class="scent-title">{{ p.name }}</span>
                  <div class="mobile-only-meta">
                    <span class="m-square-matte">{{ getSex(p.gender) }}</span> 
                    <span class="m-square-matte">{{ p.factory }}</span> 
                    <span class="m-square-matte">{{ p.quality }}</span>
                  </div>
                </div>
              </div>

              <div class="cell desk-only center"><div class="badge-square-matte">{{ getSex(p.gender) }}</div></div>
              <div class="cell desk-only center"><div class="badge-square-matte">{{ p.factory }}</div></div>
              <div class="cell desk-only center"><div class="badge-square-matte">{{ p.quality }}</div></div>

              <div class="price-container">
                <div class="price-section mono center" :style="gridStyle">
                  <div v-if="showPrices.p50" class="p-col line">{{ p.p50 }}₽</div>
                  <div v-if="showPrices.p500" class="p-col line">{{ p.p500 }}₽</div>
                  <div v-if="showPrices.p1000" class="p-col bold last">{{ p.p1000 }}₽</div>
                </div>
              </div>
            </div>

            <div class="row-aura-overlay">
              <span class="aura-text">ПЕРЕЙТИ К АРОМАТУ</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'

const isDark = ref(true); 
const loading = ref(true); 
const products = ref([]); 
const search = ref(''); 
const showSug = ref(false);
const showFilters = ref(false);

const isNewOnly = ref(false);
const activeGender = ref('ВСЕ'); 
const activeQuality = ref('ВСЕ'); 
const sortBy = ref('id');
const activeFactory = ref('ВСЕ');
const autoHighlightId = ref(null);
let highlightInterval = null;

const showPrices = ref({ p50: true, p500: true, p1000: true });
const priceLabels = { p50: '50Г', p500: '500Г', p1000: '1КГ' };
const activePriceCount = computed(() => Object.values(showPrices.value).filter(Boolean).length);

const genderOptions = [{ label: 'ВСЕ', val: 'ВСЕ' }, { label: 'M', val: 'm' }, { label: 'Ж', val: 'w' }, { label: 'У', val: 'y' }];
const qualityOptions = [{ label: 'ВСЕ', val: 'ВСЕ' }, { label: 'TOP', val: 'TOP' }, { label: 'Q1', val: 'Q1' }, { label: 'Q2', val: 'Q2' }];
const factoryOptions = [{ label: 'ВСЕ', val: 'ВСЕ' }, { label: 'LUZI', val: 'LUZI' }, { label: 'EPS', val: 'EPS' }, { label: 'SELUZ', val: 'SELUZ' }];

const sortOptions = [
  { labelHTML: '<span class="big-txt">ID</span>', val: 'id' }, 
  { labelHTML: '<span class="big-txt">₽</span>▲', val: 'asc' }, 
  { labelHTML: '<span class="big-txt">₽</span>▼', val: 'desc' }
];

const toggleNew = () => isNewOnly.value = !isNewOnly.value;

const togglePrice = (key) => {
  const activeKeys = Object.values(showPrices.value).filter(Boolean);
  if (showPrices.value[key] && activeKeys.length === 1) return;
  showPrices.value[key] = !showPrices.value[key];
}

const gridStyle = computed(() => ({ gridTemplateColumns: `repeat(${activePriceCount.value}, 1fr)` }));

const parseCSV = (data) => {
  const rows = data.split(/\r?\n/).filter(line => line.trim());
  return rows.map(row => {
    const col = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
    if (isNaN(parseInt(col[0])) || !col[2]) return null;
    let g = col[4] ? col[4].toLowerCase().trim() : '';
    let fG = (g === 'm' || g === 'м' || g.includes('муж')) ? 'm' : (g === 'w' || g === 'ж' || g.includes('жен')) ? 'w' : (g === 'y' || g === 'у' || g.includes('уни')) ? 'y' : '';
    
    const statusCol = col[10] ? col[10].trim() : '';
    const rawNote = (col[11] || '').toUpperCase();
    const brand = col[2] || '';
    const name = col[3] || '';
    
    const hasPlus = statusCol.includes('+'); 
    const hasMinus = statusCol.includes('-'); 
    const isNew = hasPlus || statusCol.toUpperCase().includes('NEW') || rawNote.includes('NEW') || brand.toUpperCase().includes('NEW') || name.toUpperCase().includes('NEW');
    const isOut = hasMinus;

    return { 
      id: col[0], 
      link: col[1] || '', 
      brand: brand, 
      name: name, 
      gender: fG, 
      factory: col[5] || '', 
      quality: col[6] || '', 
      p50: parseInt(col[7]) || 0, 
      p500: parseInt(col[8]) || 0, 
      p1000: parseInt(col[9]) || 0, 
      status: statusCol,
      isOut: isOut,
      isNew: isNew
    }
  }).filter(p => p !== null);
}

const loadData = async () => {
  try {
    const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vTtT4zLEY49maKt0VxanZWA2ORKO1h39Mc5wB-XcZclDTmWfroFxQNAPxomg3x0-w/pub?gid=1234145733&single=true&output=csv');
    products.value = parseCSV(await res.text());
    setTimeout(() => loading.value = false, 800);
    startAutoHighlight();
  } catch (e) { console.error(e); }
}

const startAutoHighlight = () => {
  highlightInterval = setInterval(() => {
    // Only highlight if products are loaded
    if (sortedProducts.value.length > 0) {
      // Pick random visible index
      const visible = sortedProducts.value;
      const randomIdx = Math.floor(Math.random() * visible.length);
      const product = visible[randomIdx];
      
      // Do not highlight if out of stock (optional preference)
      if (product) {
         autoHighlightId.value = product.id;
         // Remove highlight after 2 seconds
         setTimeout(() => { autoHighlightId.value = null; }, 2000);
      }
    }
  }, 6000); // Every 6 seconds
}

const hideSug = () => setTimeout(() => showSug.value = false, 200);

const filteredProducts = computed(() => {
  return products.value.filter(p => {
    const s = search.value.toLowerCase();
    const matchesSearch = p.name.toLowerCase().includes(s) || p.brand.toLowerCase().includes(s);
    const matchesGender = activeGender.value === 'ВСЕ' || p.gender === activeGender.value;
    const matchesQuality = activeQuality.value === 'ВСЕ' || p.quality === activeQuality.value;
    const matchesFactory = activeFactory.value === 'ВСЕ' || p.factory.toUpperCase().includes(activeFactory.value);
    const matchesNew = !isNewOnly.value || p.isNew;
    return matchesSearch && matchesGender && matchesQuality && matchesFactory && matchesNew;
  });
})

const sortedProducts = computed(() => {
  let list = [...filteredProducts.value];
  if (sortBy.value === 'asc') list.sort((a,b) => a.p1000 - b.p1000);
  else if (sortBy.value === 'desc') list.sort((a,b) => b.p1000 - a.p1000);
  else list.sort((a,b) => a.id - b.id);
  return list;
})

const stats = computed(() => {
  const p = filteredProducts.value; const count = p.length || 1;
  let s50 = 0, s500 = 0, s1000 = 0, avail = 0;
  const qual = { 'TOP': 0, 'Q1': 0, 'Q2': 0 };
  p.forEach(i => {
    if (qual[i.quality] !== undefined) qual[i.quality]++;
    if (!i.isOut) avail++;
    s50 += i.p50; s500 += i.p500; s1000 += i.p1000;
  });
  return { total: p.length, availability: Math.round((avail / count) * 100), avg50: Math.round(s50 / count), avg500: Math.round(s500 / count), avg1000: Math.round(s1000 / count), qualityPerc: { 'TOP': Math.round((qual['TOP'] / count) * 100), 'Q1': Math.round((qual['Q1'] / count) * 100), 'Q2': Math.round((qual['Q2'] / count) * 100) } }
})

const getSex = (g) => ({ m: 'МУЖ', w: 'ЖЕН', y: 'УНИ' }[g] || '—');
const open = (u) => window.open(u.startsWith('http') ? u : `https://${u}`, '_blank');
onMounted(loadData);
onUnmounted(() => { if (highlightInterval) clearInterval(highlightInterval); });
</script>

<style scoped>
@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap');

.bahur-terminal {
  --bg: #000; --text: #fff; --border: rgba(255,255,255,0.08); --dim: #555; --green: #00ff88; --red: #ff3b30;
  --panel-bg: rgba(10,10,10,0.98); --seg-bg: rgba(255,255,255,0.08); --seg-act: #fff; --seg-txt-act: #000;
  --aura-bg: rgba(0,0,0,0.4); --aura-text: #fff;
  --track-bg: rgba(255,255,255,0.15); /* Track color default */
  --sticky-bg: rgba(0,0,0,0.85); /* Sticky header bg */
  
  min-height: 100vh; background: var(--bg); color: var(--text); 
  font-family: 'Quicksand', sans-serif;
  transition: 0.1s;
}

.noir { --bg: #000; --text: #fff; --aura-bg: rgba(0,0,0,0.4); --track-bg: rgba(255,255,255,0.15); --sticky-bg: rgba(0,0,0,0.85); }

.bahur-terminal:not(.noir) { 
  --bg: #f2f2f7; 
  --text: #000; --border: rgba(0,0,0,0.1); --dim: #888; 
  --panel-bg: rgba(15,15,15,0.98); --seg-bg: rgba(255,255,255,0.1); --seg-act: #fff; --seg-txt-act: #000;
  --aura-bg: rgba(255,255,255,0.5); --aura-text: #000;
  --track-bg: rgba(0,0,0,0.1); /* Darker track for light mode */
  --sticky-bg: rgba(242,242,247,0.85); /* Sticky header bg light */
}

.container { max-width: 1400px; margin: 0 auto; padding: 15px; }
.mono { font-family: 'JetBrains Mono', monospace; }

/* STICKY NAV GROUP - UNIFIED */
.sticky-nav-group {
  position: sticky; top: 0; z-index: 500;
  background: var(--sticky-bg);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--text);
  margin-bottom: 0;
}
/* Remove bottom border from child items to avoid double lines */
.top-bar-controls { border-bottom: none !important; }

/* CONTROLS NEW LAYOUT */
.relative-zone { position: relative; z-index: 501; }

.top-bar-controls {
  display: flex; justify-content: space-between; align-items: center; 
  padding: 10px 0; border-bottom: 0.5px solid var(--border);
}

/* CUSTOM SWITCH GROUP */
.switch-group { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.ctrl-icon-small { width: 14px; height: 14px; color: var(--green); }
.ctrl-label-inline { font-size: 11px; font-weight: 700; letter-spacing: 1.5px; color: var(--text); opacity: 0.9; }

/* SOFT SWITCH FIX */
.soft-switch {
  width: 36px; height: 20px;
  position: relative; display: flex; align-items: center;
  margin-left: 5px; cursor: pointer;
}
.soft-track {
  position: absolute; width: 100%; height: 100%;
  background: var(--track-bg); /* USES VAR NOW */
  border-radius: 20px;
  transition: 0.3s ease;
}
.soft-knob {
  width: 14px; height: 14px; background: #333;
  border-radius: 50%; position: absolute; left: 3px;
  display: flex; justify-content: center; align-items: center;
  transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
.knob-dot {
  width: 4px; height: 4px; border-radius: 50%;
  background: #666; transition: 0.3s;
}

.soft-switch.active .soft-track { background: rgba(0,255,136, 0.2); }
.soft-switch.active .soft-knob { transform: translateX(16px); background: #222; }
.soft-switch.active .knob-dot { background: #00ff88; box-shadow: 0 0 5px #00ff88; }

/* SETTINGS BUTTON */
.settings-btn {
  display: flex; align-items: center; gap: 8px;
  background: none; border: none; color: var(--text);
  font-family: 'Quicksand', sans-serif;
  font-size: 11px; font-weight: 700; letter-spacing: 1px; cursor: pointer;
}
.btn-icon { width: 16px; height: 16px; opacity: 0.8; }

.click-overlay {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  z-index: 800; background: transparent;
}

.bahur-popup-menu {
  position: absolute; top: 50px; right: 0; width: 260px;
  background: var(--panel-bg); backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.05); border-radius: 12px;
  padding: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
  display: flex; flex-direction: column; gap: 14px;
  z-index: 999;
}
.bahur-popup-menu * { color: #fff; } 

.popup-row {
  display: flex; flex-direction: column; gap: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;
}
.popup-row:last-child { border-bottom: none; padding-bottom: 0; }

.popup-head { display: flex; align-items: center; gap: 10px; }
.pop-icon { width: 15px; height: 15px; opacity: 0.8; }
.popup-label { 
  font-family: 'Quicksand', sans-serif; font-size: 10px; font-weight: 700; 
  letter-spacing: 1.5px; opacity: 0.9; text-transform: uppercase; 
}

.seg-control {
  display: flex; background: rgba(255,255,255,0.05); border-radius: 8px; padding: 3px;
}
.seg-btn {
  flex: 1; background: transparent; border: none; 
  padding: 8px 0; font-size: 11px; font-weight: 600;
  border-radius: 6px; cursor: pointer; transition: 0.2s;
  opacity: 0.6; text-align: center;
  font-family: 'Quicksand', sans-serif;
  color: #fff;
}
.seg-btn.active {
  background: #fff; opacity: 1;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.seg-btn.active, .seg-btn.active span, .seg-btn.active :deep(.big-txt) {
  color: #000 !important;
  font-weight: 800;
}
:deep(.big-txt) { 
  font-family: 'JetBrains Mono'; font-weight: 700; font-size: 13px; 
  vertical-align: middle; line-height: 1; display: inline-block;
  margin-right: 2px;
}

.pop-enter-active, .pop-leave-active { transition: all 0.2s ease-out; }
.pop-enter-from, .pop-leave-to { opacity: 0; transform: translateY(-5px) scale(0.98); }

.badge-new-square { 
  display: inline-block; background: var(--text); color: var(--bg); 
  font-size: 7px; font-weight: 900; padding: 1px 3px; margin-bottom: 4px; line-height: 1;
}

.loading-container { display: flex; justify-content: center; align-items: center; height: 300px; }
.loading-line { width: 0; height: 1px; background: var(--text); animation: load 1.5s infinite ease-in-out; }
@keyframes load { 0% { width: 0; opacity: 0; } 50% { width: 200px; opacity: 1; } 100% { width: 0; opacity: 0; } }

.header-manifest { text-align: center; margin-bottom: 30px; }
.logo-strip-box { display: inline-block; position: relative; padding: 12px 60px; }
.strip { height: 0.5px; background: var(--text); width: 100%; position: absolute; left: 0; opacity: 0.3; }
.strip.top { top: 0; } .strip.bottom { bottom: 0; }
.logo-text { font-size: 36px; font-weight: 900; margin: 0; letter-spacing: 0.25em; font-family: 'Inter', sans-serif; }
.logo-url { font-size: 9px; color: var(--dim); font-weight: 700; letter-spacing: 2px; margin-top: 5px; }
.theme-centered { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); background: none; border: 0.5px solid var(--border); color: var(--text); padding: 4px 8px; cursor: pointer; border-radius: 2px; font-size: 12px; }

.dash-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 30px; }
.stat-card { border: 0.5px solid var(--border); padding: 18px; background: var(--bg); border-left: 3.5px solid var(--text); }
.d-label { display: block; font-size: 8px; font-weight: 700; color: var(--dim); margin-bottom: 12px; letter-spacing: 1.5px; text-transform: uppercase; }
.stat-card .v { font-size: 24px; font-weight: 700; }
.responsive-text { font-size: clamp(10px, 1.1vw, 14px); }
.avg-row { margin-bottom: 4px; color: var(--dim); }
.avg-row .val { color: var(--text); font-weight: 700; margin-left: 4px; }
.q-row-stacked, .stock-box-stacked { margin-bottom: 10px; }
.q-meta { display: flex; justify-content: space-between; font-size: 9px; font-weight: 600; margin-bottom: 5px; }
.op-5 { opacity: 0.5; }
.q-track-neon { height: 2px; background: var(--border); width: 100%; overflow: hidden; }
.q-fill-neon { height: 100%; background: var(--text); box-shadow: 0 0 5px var(--text); transition: 1s ease-out; }
.v-small { font-size: 16px; font-weight: 700; margin-bottom: 5px; }

.search-wrapper { position: relative; width: 100%; display: flex; align-items: center; }
.search-icon { width: 15px; height: 15px; color: var(--dim); margin-right: 10px; }
/* UPDATED SEARCH FONT TO MATCH HEADERS */
.header-search { 
  width: 100%; background: none; border: none; color: var(--text); 
  font-family: 'Quicksand'; outline: none; 
  text-transform: uppercase; font-weight: 700; letter-spacing: 1.5px; font-size: 10px;
}
.header-search::placeholder { opacity: 0.5; color: var(--text); }

.grid-table { display: flex; flex-direction: column; width: 100%; min-width: 1000px; border: 0.5px solid var(--border); border-top: none; }
.grid-row { 
  display: grid; 
  grid-template-columns: 60px 1fr 80px 120px 120px calc(var(--p-cols) * 80px); 
  align-items: center; 
  background: var(--bg); border-bottom: 0.5px solid var(--border); position: relative; overflow: hidden; 
}
/* HEAD IS NOW IN STICKY GROUP, NOT TABLE */
.grid-row.head { border-bottom: none; background: transparent; }

.cell { height: 100%; display: flex; align-items: center; padding: 15px; border-right: 0.5px solid var(--border); }
.head-txt { font-size: 8px; font-weight: 700; color: var(--dim); text-transform: uppercase; letter-spacing: 1.5px; }
.center { justify-content: center; text-align: center; }

.row-visual-layer { display: contents; }
.clickable-row { cursor: pointer; transition: 0.3s; }
.out { opacity: 0.5; }

/* AURA EFFECT */
.row-aura-overlay {
  position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
  opacity: 0; backdrop-filter: blur(0px); background: transparent;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10;
  pointer-events: none; /* Allows click through */
}
/* Hover OR Simulated Hover triggers aura */
.clickable-row:hover .row-aura-overlay, 
.clickable-row.simulated-hover .row-aura-overlay {
  opacity: 1; backdrop-filter: blur(8px); background: var(--aura-bg);
}
/* CLICK removes Aura (Active state) */
.clickable-row:active .row-aura-overlay {
  opacity: 0 !important; backdrop-filter: none !important;
}

.aura-text {
  font-size: 11px; font-weight: 900; letter-spacing: 5px; color: var(--aura-text);
  transform: translateY(15px); opacity: 0; transition: 0.5s;
}
.clickable-row:hover .aura-text,
.clickable-row.simulated-hover .aura-text {
  opacity: 1; transform: translateY(0);
}
.clickable-row:active .aura-text { opacity: 0 !important; }

.badge-square-matte { font-size: 9px; font-weight: 700; border: 0.5px solid var(--border); padding: 5px 12px; letter-spacing: 1px; text-transform: uppercase; margin: 0 auto; color: var(--text); opacity: 0.8; }
.m-square-matte { font-size: 8px; font-weight: 700; border: 0.5px solid var(--border); padding: 2px 6px; opacity: 0.7; text-transform: uppercase; }

.id-zone-square { flex-direction: column; gap: 5px; justify-content: center; border-right: 0.5px solid var(--border); padding: 8px 0; }
.id-sq-top { font-size: 14px; font-weight: 900; color: var(--dim); }
.lamp-sq { width: 14px; height: 3px; margin: 0 auto; border-radius: 1px; }
.lamp-sq.green { background: var(--green); box-shadow: 0 0 8px var(--green); }
.lamp-sq.red { background: var(--red); opacity: 0.8; }
.lamp-sq.standard { background: var(--text); opacity: 0.5; }

.scent-info { width: 100%; padding-left: 10px; }
.brand-code { font-size: 9px; font-weight: 800; opacity: 0.4; display: block; text-transform: uppercase; letter-spacing: 1px; }
.scent-title { font-size: 17px; font-weight: 600; line-height: 1.2; letter-spacing: 0.5px; }
.mobile-only-meta { display: none; margin-top: 8px; gap: 5px; }

.price-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
.price-section { display: grid; height: 100%; width: 100%; align-items: center; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
.p-col { text-align: center; font-size: 15px; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; white-space: nowrap; }
.p-col.line { border-right: 0.5px solid var(--border); }
.head-p .p-col { font-size: 8px; font-weight: 700; color: var(--dim); letter-spacing: 1.5px; }

@media (max-width: 900px) {
  .dash-grid { grid-template-columns: 1fr 1fr; }
  .grid-table { min-width: 100%; border: none; }
  .cell { border-right: none; }
  .desk-only { display: none; }
  .mobile-only-meta { display: flex; }
  .grid-row { grid-template-columns: 35px 1fr calc(var(--p-cols) * 55px); border-bottom: 0.5px solid var(--border); }
  .id-zone-square { border-right: none; padding-left: 2px !important; align-items: flex-start; }
  .id-sq-top { font-size: 9px; }
  .lamp-sq { width: 10px; margin: 0; }
  .border-right-mobile { border-right: 0.5px solid var(--border) !important; padding-right: 5px; }
  .scent-info { padding-left: 2px; }
  .scent-title { font-size: 13px; }
  .price-container { width: calc(var(--p-cols) * 55px); }
  .price-section { border-right: none; }
  .p-col { padding: 0; font-size: 12px; border-right: 0.5px solid var(--border) !important; }
  .p-col.last { border-right: none !important; }
  .aura-text { font-size: 9px; letter-spacing: 2px; }
}
</style>
